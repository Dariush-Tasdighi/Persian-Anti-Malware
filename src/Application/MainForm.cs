namespace Application;

public partial class MainForm : Infrastructure.BaseForm
{
	public MainForm()
	{
		InitializeComponent();
	}

	private async void MainForm_Load
		(object sender, System.EventArgs e)
	{
		scanButton.Enabled = false;
		checkForUpdateButton.Enabled = false;

		pathNameScanningLabel.Text = string.Empty;

		drivesCheckedListBox.SelectionMode =
			System.Windows.Forms.SelectionMode.One;

		infectedFilesCheckedListBox.SelectionMode =
			System.Windows.Forms.SelectionMode.One;

		RefreshDrives();

		await LoadMD5HashesAsync();
	}

	private async void CheckForUpdateButton_Click(object sender, System.EventArgs e)
	{
		scanButton.Enabled = false;
		checkForUpdateButton.Enabled = false;

		var stopwatch =
			new System.Diagnostics.Stopwatch();

		stopwatch.Start();

		bool hadUpdate = false;

		string message;
		var messageHelper =
			new Infrastructure.MessageHelper();

		try
		{
			hadUpdate =
				await
				Infrastructure.DownloadHelper.DownloadUpdatesAsync();

			if (hadUpdate == false)
			{
				message =
					"System is update.";
			}
			else
			{
				message =
					"System has been updated successfully.";
			}

			messageHelper.AddMessage(message: message);
		}
		catch (System.Exception ex)
		{
			message = ex.Message;
			messageHelper.AddMessage(message: message);
		}

		stopwatch.Stop();

		message =
			$"Time Taken: {stopwatch.Elapsed}";

		messageHelper.AddMessage(message: message);

		System.Windows.Forms.MessageBox.Show(text: messageHelper.ToString());

		if (hadUpdate)
		{
			await LoadMD5HashesAsync();
		}

		scanButton.Enabled = true;
		checkForUpdateButton.Enabled = true;
	}

	private void RefreshDrivesButton_Click(object sender, System.EventArgs e)
	{
		RefreshDrives();
	}

	private void RefreshDrives()
	{
		drivesCheckedListBox.Items.Clear();

		var drives =
			System.IO.DriveInfo.GetDrives();

		foreach (var drive in drives)
		{
			drivesCheckedListBox.Items.Add(item: drive.Name);
		}
	}

	private async System.Threading.Tasks.Task LoadMD5HashesAsync()
	{
		var stopwatch =
			new System.Diagnostics.Stopwatch();

		stopwatch.Start();

		string message;
		var messageHelper =
			new Infrastructure.MessageHelper();

		try
		{
			Infrastructure.MD5Hashes.Clear();
			await Infrastructure.MD5HashesLoader.LoadAsync();

			message =
				"Loading Malware Definitions Completed...";

			messageHelper.AddMessage(message: message);
		}
		catch (System.Exception ex)
		{
			message = ex.Message;
			messageHelper.AddMessage(message: message);
		}

		stopwatch.Stop();

		message =
			$"Time Taken: {stopwatch.Elapsed}";

		messageHelper.AddMessage(message: message);

		var malwareCount = Infrastructure
			.MD5Hashes.List.Count.ToString(format: "#,##0");

		message =
			$"System Malware Count: {malwareCount}";

		messageHelper.AddMessage(message: message);

		System.Windows.Forms.MessageBox
			.Show(text: messageHelper.ToString());

		scanButton.Enabled = true;
		checkForUpdateButton.Enabled = true;
	}

	private void ScanButton_Click
		(object sender, System.EventArgs e)
	{
		infectedFilesCheckedListBox.Items.Clear();

		if (drivesCheckedListBox.CheckedItems.Count == 0)
		{
			var message =
				"You did not specify any drive for scanning!";

			System.Windows.Forms.MessageBox.Show(text: message);

			return;
		}

		var selectedDrive =
			drivesCheckedListBox.CheckedItems[0]!.ToString();

		var form = new ScanFilesForm
		{
			Path = selectedDrive
		};

		form.ShowDialog();

		// **************************************************
		var infectedFiles =
			form.InfectedFiles;

		foreach (var infectedFile in infectedFiles)
		{
			infectedFilesCheckedListBox.Items.Add(item: infectedFile);
		}
		// **************************************************
	}

	private void SelectAllInfectedFilesButton_Click(object sender, System.EventArgs e)
	{
		SelectAllInfectedFiles();
	}

	private void SelectAllInfectedFiles()
	{
		var checkedItemCount =
			infectedFilesCheckedListBox.CheckedItems.Count;

		for (int index = 0; index <= checkedItemCount - 1; index++)
		{
			infectedFilesCheckedListBox
				.SetItemChecked(index: index, value: true);
		}
	}

	private void DeleteSelectedInfectedFilesButton_Click(object sender, System.EventArgs e)
	{
		DeleteSelectedInfectedFiles();
	}

	private void DeleteSelectedInfectedFiles()
	{
		string message;

		if (infectedFilesCheckedListBox.CheckedItems.Count == 0)
		{
			message =
				"You did not specify any file for deleting!";

			System.Windows.Forms.MessageBox.Show(text: message);
		}

		var checkedItemCount =
			infectedFilesCheckedListBox.CheckedItems.Count;

		for (int index = checkedItemCount - 1; index >= 0; index--)
		{
			var item =
				infectedFilesCheckedListBox.CheckedItems[index];

			if (item is null)
			{
				continue;
			}

			var pathName =
				item.ToString();

			if (string.IsNullOrWhiteSpace(value: pathName))
			{
				continue;
			}

			try
			{
				System.IO.File.Delete(path: pathName);
				infectedFilesCheckedListBox.Items.Remove(value: item);
			}
			catch (System.Exception ex)
			{
				System.Windows.Forms.MessageBox.Show(text: ex.Message);
			}
		}
	}
}
